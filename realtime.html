<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TerraBase Real-Time</title>
    <link rel="stylesheet" href="realtime/realtime.css" />
    <link rel="stylesheet" href="MarkerCluster.css" />
    <link rel="stylesheet" href="MarkerCluster.Default.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.2/leaflet.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="L.Control.Locate.min.js" charset="utf-8"></script>
    <script src="realtime/leaflet-liveupdate.js"></script>
    <script src="realtime/leaflet-messagebox.js"></script>
    <script src="leaflet.markercluster.js"></script>
    <script src="esri-leaflet.js"></script>
    <script src="realtime/canvasjs.min.js"></script>
</head>
<body>
  <div id="menu-toggle">
  <i class="fa fa-bars fa-2x"></i></div>
  <div id="wrapper">

  <!-- Sidebar -->
  <div id="sidebar-wrapper">
      <ul class="sidebar-nav">
        <br>
          <li class="sidebar-brand">
              <a href="#"> 
              </a>
          </li>
          <li>
            <div class="btn-group">
              <button type="button" data='6' class="btn btn badgegreen">
                Headquarters <span class="badge badge-light">ok</span>
              </button>
              <button type="button" data='5' class="btn btn badgeorange">
                Parking <span class="badge badge-light">3</span>
              </button>
            </div>
          </li>
          <li>
            <div class="btn-group">
              <button type="button" data='1' class="btn btn badgeyellow">
              Office 1 <span class="badge badge-light">2</span>
              </button>
              <button type="button" data='2' class="btn btn badgegreen">
              Storage <span class="badge badge-light">ok</span>
              </button>
            </div>
          </li>
          <li>
            <div class="btn-group">
              <button type="button" data='3' class="btn btn badgegreen">
              Office 2 <span class="badge badge-light">ok</span>
              </button>
              <button type="button" data='3' class="btn btn badgegreen">
              Main Office <span class="badge badge-light">ok</span>
              </button>
            </div>
          </li>
          <li>
            <div class="btn-group">
              <button type="button" data='7' class="btn btn badgeyellow">
                Startbucks <span class="badge badge-light">2</span>
              </button>
              <button type="button" data='8' class="btn btn badgegreen">
                Sheraton <span class="badge badge-light">ok</span>
              </button>
            </div>
          </li>
           <li>
            <div class="btn-group">
              <button type="button" data='9' class="btn btn badgegreen">
              Geneva 1 <span class="badge badge-light">ok</span>
              </button>
              <button type="button" data='10' class="btn btn badgegreen">
              Geneva 2 <span class="badge badge-light">ok</span>
              </button>
            </div>
          </li>
           <li>
            <div class="btn-group">
              <button type="button" data='11' class="btn btn badgegreen">
                Singapore <span class="badge badge-light">ok</span>
              </button>
              <button type="button" data='12' class="btn btn badgeorange">
              JFK <span class="badge badge-light">3</span>
            </button>
            </div>
          </li>
      </ul>

      <div style="position: absolute;bottom: 1px;right: 1px;color: white;cursor: pointer;"><a target="_blank" href="realtime/aqi.pdf"><i class="fa fa-info-circle"></i>  Air Quality Index</a></div>
    </div>
  </div>
  <div id="splitd">
      <div id="viewDiv">
      </div>
      <div id="closeseries"><i style="float: right;padding: 10px;cursor: pointer;" class="fa fa-window-close" aria-hidden="true"></i></div>
      <div id="timeseriesDiv">
      </div>
  </div>
  <div id="sizeInputDiv">
    <label style="float: right;">TerraBase Data Monitoring
    </label>
    <br>
    <br>
    <img src="indeterminate.gif" id="loadinggf" style="float:left;">
    <div style="float: right;display: none;">
      <label for="interpLayerToggle">Toggle Map Points
      </label>
      <div style="float:right;padding-left: 10px;">
        <input type="checkbox" id="interpLayerToggle" checked/>
      </div>
    </div>
  </div>
  <div id="basemaps-wrapper" class="leaflet-bar">
    <select name="basemaps" id="basemaps" onChange="changeBasemap(basemaps)">
      <option value="Topographic">Topographic</option>
      <option value="Streets">Streets</option>
      <option value="Oceans">Oceans</option>
      <option value="Gray">Gray</option>
      <option value="Imagery">Imagery</option>
      <option value="ShadedRelief">Shaded Relief</option>
    </select>
  </div>
  <script>
    startupMap();
    
    function startupMap(){
      me = this;

      me.datalist = [];
      me.resultLyr = [];
      
      me.listofcolors = {
        '#A6CE39':'green', 
        '#FFF200':'yellow', 
        '#ED1D24':'red', 
        '#A2064A':'purple', 
        '#F7901E':'orange', 
        '#891A1C':'bad'
      };
      me.listofcolorsRank = {
        'green':1, 
        'yellow':2,  
        'orange':3,
        'red':4, 
        'purple':5, 
        'bad':6
      };

      me.markers = L.markerClusterGroup({
        iconCreateFunction: function (cluster) {
          var childMarkers = cluster.getAllChildMarkers();
          var colorofIcon = 'green';

          for (var markeringroup in childMarkers){ 
             if(me.listofcolorsRank[colorofIcon] < me.listofcolorsRank[me.listofcolors[childMarkers[markeringroup].options.fillColor]] ){
                colorofIcon = me.listofcolors[childMarkers[markeringroup].options.fillColor]; 
             }
          }

          return L.divIcon({ html: cluster.getChildCount(), 
            className:'cluster cluster'+colorofIcon,
            iconSize: null
          });
        },
      });
      me.mapinterval = 30;

      $("#chemNameDropdown").on('change', me.refreshData);
      $("#interpLayerToggle").click(me.toggleInterpolateLayer);

      var options = {messagebox: true };
      me.map = L.map('viewDiv', options).setView([30.458,-91.1811], 15);
      me.layer = L.esri.basemapLayer('Imagery').addTo(map);

      map.on('load', function () {
          mapLoaded = true;
      });
      map.zoomControl.setPosition('bottomleft');

      /*map.on('click', function(e) {
          return false;
      });*/
      var positions = [ 'topleft', 'topright', 'bottomleft', 'bottomright' ];

      L.control.locate({ position: 'bottomleft' }).addTo(map);
      L.control.liveupdate ({
        update_map: function () {
          if(me.mapinterval == 0){
              me.mapinterval = 30;
              getRealtimePoints();
          }
          else{
            me.mapinterval = me.mapinterval-1;
          }
          var msg = "Data refresh in " + me.mapinterval;
          map.messagebox.setPosition('bottomright');
          map.messagebox.options.timeout = 7000;
          map.messagebox.show(msg);
        },
        position: 'bottomleft',
        interval: 1000
      })
      .addTo(map)
      .startUpdating();

      getRealtimePoints();

      addOtherthings();

      $('.btn').click(me.badgeCLick);

      $('#closeseries').click(me.closeseriesDiv);

      $("#menu-toggle").click(function(e) {
          e.preventDefault();
          $("#wrapper").toggleClass("toggled");
          $("#timeseriesDiv").toggleClass("toggled");
          $("#viewDiv").toggleClass("toggled");

          if($( window ).width()> $('#viewDiv').width()){
            $('#viewDiv').width($('#splitd').width());
            $('#timeseriesDiv').width($('#splitd').width());                
          }
          else{
            $('#viewDiv').width($('#splitd').width()-250);
            $('#timeseriesDiv').width($('#splitd').width()-250); 
          }
      });
    }

    function closeseriesDiv(){

      $('#timeseriesDiv').hide();
      $('#viewDiv').height($('#splitd').height());
      $('#closeseries').hide();
    }

    function getRealtimePoints(){

      var reqUrl = "https://localhost:44321/api/Tenant/1190/Report/Custom/IndoorSensor/Locations";
      //var reqUrl = "realtime/points.json";
      me.datalist = [];
      $.ajax({
            type: "GET",
            //async: true,
            url: reqUrl
            //contentType: "application/json; charset=utf-8",
            //dataType: "json"
        })
        .fail(function (error) {
            alert("Service Error For Requested Locations");
        })
        .done(function (data) {
          if(data.length>0){
            
            //Add Dynamic badges
            for (var group in data){ 
                 me.datalist.push(data[group]);
                 //$("#container").append($('<option></option>').val(data[group].Location).html(data[group].Location));
              }
            }
            refreshData();
      });
    }

    function refreshData(){
      
      $("#refreshDataID").attr('value', "Loading...");  
      $("#loadinggf").show();
      
      me.map.removeLayer(me.resultLyr);
      me.map.removeLayer(me.markers);
      me.markers.clearLayers();
      ///var chemID = document.getElementById('chemNameDropdown').value;

      me.resultLyr = {
        type: "FeatureCollection",
        id: 1,
        features: []
      };

      var datalist2Map = [];

      if(me.datalist.length>0){

        try{
            for (var group in me.datalist){ 
              
              var obj = {};

              obj.properties = me.datalist[group];
              obj.type = "Feature";
              obj.geometry = {
                  coordinates: [
                  me.datalist[group].Longitude,
                  me.datalist[group].Latitude
                  ],
                  type: "Point"
              };
              me.resultLyr.features.push(obj);
          }

          me.resultLyr = L.geoJson(me.resultLyr, {
            
            onEachFeature:function(feature, layer){

              var dateString = new Date().toISOString();
              var requesturl = "https://localhost:44321/api/Tenant/1190/Report/Custom/IndoorSensor/Data/One?Id="+feature.properties.aliasID+"&endDt="+dateString;

              layer.on('click', function(e){
                  me.featureName = feature.properties.Location;
                  me.featureID = feature.properties.aliasID;

                  $("#loadinggf").show();

                  $.ajax({
                      type: "GET",
                      url: requesturl
                  })
                  .fail(function (error) {
                      alert("Service Error For Requested Locations");
                  })
                  .done(function (data) {
                    var dateFormat = new Date(data[0].LocalReadingDt).toLocaleString();

                      //fa-circle
                      layer.bindPopup('<b><label class="poptitle">'+me.featureName+'</></b><br><table id="popuptable" style="width:100%">'+dateFormat+'</td></tr>'+chartForTemp(data[0].Temp,me.featureID)+chartForCO(data[0].CO,me.featureID)+chartForOzone(data[0].Ozone,me.featureID)+chartForNO(data[0].NO,me.featureID)+chartForNO2(data[0].NO2,me.featureID)+chartForSO2(data[0].SO2,me.featureID)+chartForNOx(data[0].NOx,me.featureID)+chartForPM10(data[0].PM10,me.featureID)+chartForPM25(data[0].PM25,me.featureID)+chartForPressure(data[0].Pressure,me.featureID)+chartForVolatiles(data[0].tVOC,me.featureID)+'</table>').openPopup();
                      $("#loadinggf").hide();
                });
              });
            },
            pointToLayer: function (feature, latlng) {

                var pointcolor = '#A6CE39';//green //default
                if(feature.properties.aliasID == 1339) {
                  pointcolor = '#FFF200';//yellow
                }
                else if(feature.properties.aliasID == 1344){
                  pointcolor = '#F7901E'; //orange
                }
                /*else if(feature.properties.aliasID == 1343 ){
                  pointcolor = '#891A1C';//bad
                }*/
                /*else if(feature.properties.aliasID == 1340){
                  pointcolor = '#ED1D24';//red
                }*/
                /*else if(feature.properties.aliasID == 1341){
                  pointcolor = '#A2064A';//purple
                }*/

                var geojsonMarkerOptions = {
                    radius: 10,
                    fillColor: pointcolor,
                    color: "#000",
                    weight: 1,
                    opacity: .9,
                    fillOpacity: 0.7
                };

                return L.circleMarker(latlng, geojsonMarkerOptions);
            }
          });

          me.markers.addLayer(me.resultLyr);
          me.map.addLayer(me.markers);      
          me.map.fitBounds(me.resultLyr.getBounds());     
        }
        catch (e){
          alert("There is no valid data in this query.<br>"+e);
        }
      }
      else{
        alert("There is no valid data in this query.");
      }
             
      $("#refreshDataID").html("Check Points");  
      $("#loadinggf").hide();
    }

    function chartForCO(val,f_id){
      return '<tr><th>CO:</th><td>'+val+' ppm<a onClick="me.popupChartClick(\'CO\','+f_id+')" ><i data="CO" title="Graph CO" class="fa fa-line-chart green"></i></a></td></tr>';
    }

    function chartForTemp(val,f_id){
      return '<tr><th>Temp:</th><td>'+val+' F<a onClick="me.popupChartClick(\'Temp\','+f_id+')" ><i data="Temp" title="Graph Temperature" class="fa fa-line-chart orange"></i></a></td></tr>';
    }
    function chartForOzone(val,f_id){
      return '<tr><th>Ozone:</th><td>'+val+' ppm<a onClick="me.popupChartClick(\'Ozone\','+f_id+')" ><i data="Ozone" title="Graph Ozone" class="fa fa-line-chart yellow"></i></a></td></tr>';
    }

    function chartForVolatiles(val,f_id){
      return '<tr><th>Volatiles:</th><td>'+val+' ppb<a onClick="me.popupChartClick(\'tVOC\','+f_id+')" ><i data="tVOC" title="Graph Volatiles" class="fa fa-line-chart green"></i></a></td></tr>';
    }

    function chartForNO(val,f_id){
      return '<tr><th>NO:</th><td>'+val+' ppb<a onClick="me.popupChartClick(\'NO\','+f_id+')" ><i data="NOx" title="Graph NO" class="fa fa-line-chart green"></i></a></td></tr>';
    }

    function chartForNO2(val,f_id){
      return '<tr><th>NO2:</th><td>'+val+' ppb<a onClick="me.popupChartClick(\'NO2\','+f_id+')" ><i data="NO2" title="Graph NO2" class="fa fa-line-chart green"></i></a></td></tr>';
    }

    function chartForSO2(val,f_id){
      return '<tr><th>SO2:</th><td>'+val+' ppb<a onClick="me.popupChartClick(\'SO2\','+f_id+')" ><i data="SO2" title="Graph SO2" class="fa fa-line-chart green"></i></a></td></tr>';
    }

    function chartForNOx(val,f_id){
      return '<tr><th>NOx:</th><td>'+val+' ppb<a onClick="me.popupChartClick(\'NOx\','+f_id+')" ><i data="NOx" data="NOx" title="Graph NOx" class="fa fa-line-chart green"></i></a></td></tr>';
    }

    function chartForPM10(val,f_id){
      return '<tr><th>PM10:</th><td>'+val+' ug/m3<a onClick="me.popupChartClick(\'PM10\','+f_id+')" ><i title="Graph PM10" class="fa fa-line-chart yellow"></i></a></td></tr>';
    }
    function chartForPM25(val,f_id){
      return '<tr><th>PM25:</th><td>'+val+' ug/m3<a onClick="me.popupChartClick(\'PM25\','+f_id+')" ><i data="PM25" title="Graph PM25" class="fa fa-line-chart green"></i></a></td></tr>';
    }

    function chartForPressure(val,f_id){
      return '<tr><th>Pressure:</th><td>'+val+' mbar<a onClick="me.popupChartClick(\'Pressure\','+f_id+')" ><i data="Pressure" title="Graph Pressure" class="fa fa-line-chart orange"></i></a></td></tr>';
    }

    function badgeCLick(b){

      $("#loadinggf").show();
      var idClick;
      var latclick;
      var longclick;
      for (var group in me.datalist){ 
          
          if(me.datalist[group].$id == Number($(this).attr('data'))){
            idClick = me.datalist[group].aliasID;
            latclick=me.datalist[group].Latitude;
            longclick=me.datalist[group].Longitude;
            me.featureName = me.datalist[group].Location;
          }
      }


      setTimeout(function(){ map.setView([latclick, longclick], 17) }, 1000);
      me.renderChart(idClick);
    }

    function popupChartClick(b,id){
      $("#loadinggf").show();
      me.renderChart(id, b);
    }

    function renderChart(idClick, param){

      var dateFrom = new Date();
      dateFrom = dateFrom.setDate(dateFrom.getDate() - 10);
      var dateTo = new Date();
      var dateStringTo = dateTo.toISOString();
      var dateStringFrom = new Date(dateFrom).toISOString();

      var requesturl = "https://localhost:44321/api/Tenant/1190/Report/Custom/IndoorSensor/Data/Hourly?Id="+idClick+"&endDt="+dateStringTo+"&startDt="+dateStringFrom;

      $("#loadinggf").show();
      $('#timeseriesDiv').show();
      $('#closeseries').show();

      $.ajax({
          type: "GET",
          url: requesturl
      })
      .fail(function (error) {
          alert("Service Error For Requested Locations");
      })
      .done(function (data) {
          $('#viewDiv').height($('#splitd').height() - 185);
          $('#basemaps-wrapper').css('bottom',270);

          var dataPointsTemp_Avg = [];
          var dataPointsHumidity_Avg = []
          var dataPointsSO2_Avg = [];
          var dataPointsCO_Avg = [];

          var paramValue = [];
          for (var i = 0; i < data.length; i++) {
            if(param){
              var paramName = param+ '_Avg';
              paramValue.push({
                x: new Date(data[i].LocalReadingDt),
                y: Number(Number(data[i][paramName]).toPrecision(3))
              });
            }
            else{
              dataPointsTemp_Avg.push({
                x: new Date(data[i].LocalReadingDt),
                y: Number(Number(data[i].Temp_Avg).toPrecision(3))
              });

              dataPointsHumidity_Avg.push({
                x: new Date(data[i].LocalReadingDt),
                y:  Number(Number(data[i].Humidity_Avg).toPrecision(3))
              });

              dataPointsCO_Avg.push({
                x: new Date(data[i].LocalReadingDt),
                y: Number(Number(data[i].CO_Avg).toPrecision(3))
              });

              dataPointsSO2_Avg.push({
                x: new Date(data[i].LocalReadingDt),
                y: Number(Number(data[i].SO2_Avg).toPrecision(3))
              });  
            }           
          }


          if(param){
            var dataSupply = [{
              type: "line",
              name: paramName,
              color: "#369EAD",
              showInLegend: true,
              axisYIndex: 0,
              dataPoints: paramValue
            }]
          }
          else{
            var dataSupply = [{
              type: "line",
              name: "Humidity",
              color: "#369EAD",
              showInLegend: true,
              axisYIndex: 1,
              dataPoints: dataPointsHumidity_Avg
            },
            {
              type: "line",
              name: "Temp Avg",
              color: "#C24642",
              axisYIndex: 0,
              showInLegend: true,
              dataPoints: dataPointsTemp_Avg
            },
            {
              type: "line",
              name: "CO Avg",
              color: "#7F6084",
              axisYType: "secondary",
              showInLegend: true,
              dataPoints: dataPointsCO_Avg
            },
            {
              type: "line",
              name: "SO Avg",
              color: "blue",
              axisYType: "secondary",
              showInLegend: true,
              dataPoints: dataPointsSO2_Avg
            }];

            var paramName = 'Humidity';
          }

          var chart = new CanvasJS.Chart("timeseriesDiv", {
            /*title:{
              text: ""
            },*/
            animationEnabled: true,
            zoomEnabled: true,
            axisY:[{
              title: "Temp Avg",
              lineColor: "#C24642",
              tickColor: "#C24642",
              labelFontColor: "#C24642",
              titleFontColor: "#C24642",
              suffix: "°"
            },
            {
              title: paramName,
              lineColor: "#369EAD",
              tickColor: "#369EAD",
              labelFontColor: "#369EAD",
              titleFontColor: "#369EAD"
            }],
            axisY2: {
              title: "Value",
              lineColor: "#7F6084",
              tickColor: "#7F6084",
              labelFontColor: "#7F6084",
              titleFontColor: "#7F6084"
            },
            toolTip: {
              shared: true
            },
            legend: {
              cursor: "pointer",
              itemclick: toggleDataSeries
            },
            data: dataSupply
          });
        chart.render();
        $("#loadinggf").hide();
        $('#closeseries').show();
      });
    }
    function toggleInterpolateLayer(e){
        if(me.resultLyr.options){
          if($('#interpLayerToggle').prop('checked') == true){
              me.map.addLayer(me.resultLyr);
              me.map.fitBounds(me.resultLyr.getBounds()); 
          }
          else{
              me.map.removeLayer(me.resultLyr);
          } 
        }
    }

    function setBasemap(basemap) {
      if (me.layer) {
        me.map.removeLayer(me.layer);
      }

      me.layer = L.esri.basemapLayer(basemap);

      me.map.addLayer(me.layer);
    }

    function changeBasemap(basemaps){
      var basemap = basemaps.value;
      setBasemap(basemap);
    }

    function toggleDataSeries(e) {
      if (typeof (e.dataSeries.visible) === "undefined" || e.dataSeries.visible) {
        e.dataSeries.visible = false;
      } else {
        e.dataSeries.visible = true;
      }
      e.chart.render();
    }

    function addOtherthings(){
      var logo = L.control({position: 'topright'});
      logo.onAdd = function(map){
          var div = L.DomUtil.create('div', 'myclass');
          div.innerHTML= "<a target='_blank' href='http://live.terrabase.com'><img width='60px' src='realtime/tb.png'/></a>";
          return div;
      }
      logo.addTo(map);
    }
</script>
</body>
</html>