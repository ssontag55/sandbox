<!DOCTYPE html>
<html>
  <head>
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <title>TerraBase Real-Time</title>
    <link rel="stylesheet" href="realtime/realtime.css" />
    <link rel="stylesheet" href="//cdnjs.cloudflare.com/ajax/libs/leaflet/1.0.2/leaflet.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/font-awesome/4.7.0/css/font-awesome.min.css" />
    <link rel="stylesheet" href="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/css/bootstrap.min.css">
    <script src="https://unpkg.com/leaflet@1.3.1/dist/leaflet.js"></script>
    <script src="https://ajax.googleapis.com/ajax/libs/jquery/3.3.1/jquery.min.js"></script>
    <script src="https://maxcdn.bootstrapcdn.com/bootstrap/3.3.7/js/bootstrap.min.js"></script>
    <script src="L.Control.Locate.min.js" charset="utf-8"></script>
    <script src="realtime/leaflet-liveupdate.js"></script>
    <script src="realtime/leaflet-messagebox.js"></script>
    <script src="jquery-3.1.1.min.js"></script>
    <script src="esri-leaflet.js"></script>
    <script src="realtime/canvasjs.min.js"></script>
</head>
<body>
  <div id="splitd">
      <div id="viewDiv">
      </div>
      <div id="closeseries"><i style="float: right;padding: 10px;cursor: pointer;" class="fa fa-window-close" aria-hidden="true"></i></div>
      <div id="timeseriesDiv">
      </div>
  </div>
  <div id="sizeInputDiv">
    <label>TerraBase Real-Time Data Monitoring
    </label>
    <br>
    <div class="container" style="width: 100%;">
      <div class="panel-group">
        <div class="panel panel-default" data='1339'>
          <div class="panel-heading">MW-1</div>
          <div class="panel-body" id='s1'>Offline</div>
        </div>
        <div class="panel panel-success" data='1340'>
          <div class="panel-heading">MW-2</div>
          <div class="panel-body" id='s2'>Good</div>
        </div>

        <div class="panel panel-success" data='1341'>
          <div class="panel-heading">MW-3</div>
          <div class="panel-body" id='s3'>Good</div>
        </div>

        <div class="panel panel-warning" data='1342'>
          <div class="panel-heading">MW-4</div>
          <div class="panel-body" id='s4'>Warning</div>
        </div>

        <div class="panel panel-success" data='1343'>
          <div class="panel-heading">MW-5</div>
          <div class="panel-body" id='s5'>Alert</div>
        </div>
        <div class="panel panel-danger" data='1344'>
          <div class="panel-heading">MW-6</div>
          <div class="panel-body" id='s6'>Alert</div>
        </div>
      </div>
    </div>
    <br>
    <img src="indeterminate.gif" id="loadinggf" style="float:left;">
    <div style="float: right;">
      <label for="interpLayerToggle">Toggle Map Points
      </label>
      <div style="float:right;padding-left: 10px;">
        <input type="checkbox" id="interpLayerToggle" checked/>
      </div>
    </div>
  </div>
  <div id="basemaps-wrapper" class="leaflet-bar">
    <select name="basemaps" id="basemaps" onChange="changeBasemap(basemaps)">
      <option value="Topographic">Topographic</option>
      <option value="Streets">Streets</option>
      <option value="Oceans">Oceans</option>
      <option value="Gray">Gray</option>
      <option value="Imagery">Imagery</option>
      <option value="ShadedRelief">Shaded Relief</option>
    </select>
  </div>
  <script>
    startupMap();
    
    function startupMap(){
      me = this;

      me.datalist = [];
      me.resultLyr = [];
      me.mapinterval = 30;

      $("#chemNameDropdown").on('change', me.refreshData);
      $("#interpLayerToggle").click(me.toggleInterpolateLayer);

      var options = {messagebox: true };
      me.map = L.map('viewDiv', options).setView([30.458,-91.1811], 15);
      me.layer = L.esri.basemapLayer('Imagery').addTo(map);

      map.on('load', function () {
          mapLoaded = true;
      });
      map.zoomControl.setPosition('bottomleft');

      map.on('click', function(e) {
          return false;
      });
      var positions = [ 'topleft', 'topright', 'bottomleft', 'bottomright' ];

      L.control.locate({ position: 'bottomleft' }).addTo(map);
      L.control.liveupdate ({
        update_map: function () {
          if(me.mapinterval == 0){
              me.mapinterval = 30;
              getRealtimePoints();
          }
          else{
            me.mapinterval = me.mapinterval-1;
          }
          var msg = "Data refresh in " + me.mapinterval;
          map.messagebox.setPosition('bottomright');
          map.messagebox.options.timeout = 7000;
          map.messagebox.show(msg);
        },
        position: 'bottomleft',
        interval: 1000
      })
      .addTo(map)
      .startUpdating();

      getRealtimePoints();

      addOtherthings();

      $('.panel').click(me.badgeCLick);

      $('#closeseries').click(me.closeseriesDiv);
    }

    function getRealtimePoints(){

      var reqUrl = "https://localhost:44321/api/Tenant/1190/Report/Custom/IndoorSensor/Locations";
      //var reqUrl = "realtime/points.json";

      $.ajax({
            type: "GET",
            //async: true,
            url: reqUrl
            //contentType: "application/json; charset=utf-8",
            //dataType: "json"
        })
        .fail(function (error) {
            alert("Service Error For Requested Locations");
        })
        .done(function (data) {
          //$("#container").empty();
          if(data.length>0){
            
            //Add Dynamic badges
            for (var group in data){ 
                 me.datalist.push(data[group]);
                 //$("#container").append($('<option></option>').val(data[group].Location).html(data[group].Location));
              }
            }
            refreshData();
      });
    }

    function refreshData(){
      
      $("#refreshDataID").attr('value', "Loading...");  
      $("#loadinggf").show();
      
      me.map.removeLayer(me.resultLyr);
      ///var chemID = document.getElementById('chemNameDropdown').value;

      me.resultLyr = {
        type: "FeatureCollection",
        id: 1,
        features: []
      };

      var datalist2Map = [];

      if(me.datalist.length>0){

        try{
            for (var group in me.datalist){ 
              
              var obj = {};

              obj.properties = me.datalist[group];
              obj.type = "Feature";
              obj.geometry = {
                  coordinates: [
                  me.datalist[group].Longitude,
                  me.datalist[group].Latitude
                  ],
                  type: "Point"
              };
              me.resultLyr.features.push(obj);
          }

          me.resultLyr = L.geoJson(me.resultLyr, {
            
            onEachFeature:function(feature, layer){

              var dateString = new Date().toISOString();
              var requesturl = "https://localhost:44321/api/Tenant/1190/Report/Custom/IndoorSensor/Data/One?Id="+feature.properties.ID+"&endDt="+dateString;

              me.featureName = feature.properties.Location;
              layer.on('click', function(e){
                  $("#loadinggf").show();

                  $.ajax({
                      type: "GET",
                      url: requesturl
                  })
                  .fail(function (error) {
                      alert("Service Error For Requested Locations");
                  })
                  .done(function (data) {
                      layer.bindPopup('<b>'+me.featureName+'</b><br><table style="width:100%"><tr><th>Date:</th><td>'+data[0].LocalReadingDt+'</td></tr><tr><th>CO:</th><td>'+data[0].CO+'</td></tr><tr><th>DewPoint:</th><td>'+data[0].DewPoint+'</td></tr><tr><th>Humidity:</th><td>'+data[0].Humidity+'</td></tr><tr><th>Temp:</th><td>'+data[0].Temp+'</td></tr><tr><th>NO:</th><td>'+data[0].NO+'</td></tr><tr><th>NO2:</th><td>'+data[0].NO2+'</td></tr><tr><th>SO2:</th><td>'+data[0].SO2+'</td></tr><tr><th>NO2:</th><td>'+data[0].NO2+'</td></tr><tr><th>Pressure:</th><td>'+data[0].Pressure+'</td></tr><tr><th>NO2:</th><td>'+data[0].NO2+'</td></tr><tr><th>NOx</th><td>'+data[0].NOx+'</td></tr><tr><th>NO2:</th><td>'+data[0].NO2+'</td></tr><tr><th>PM25:</th><td>'+data[0].PM25+'</td></tr></table>');
                      $("#loadinggf").hide();
                      //layer.openPopup().openOn(map);
                });
              });
            },
            pointToLayer: function (feature, latlng) {

                var pointcolor = '#ff7800';
                if(feature.properties.ID == 1339) {
                  pointcolor = '#CCC';
                }
                else if(feature.properties.ID == 1344){
                  pointcolor = 'red';
                }
                else if(feature.properties.ID == 1340 || feature.properties.ID == 1341 || feature.properties.ID == 1343 ){
                  pointcolor = 'lightgreen';
                }

                var geojsonMarkerOptions = {
                    radius: 10,
                    fillColor: pointcolor,
                    color: "#000",
                    weight: 1,
                    opacity: .9,
                    fillOpacity: 0.7
                };
                return L.circleMarker(latlng, geojsonMarkerOptions);
            }
          });

          me.map.addLayer(me.resultLyr);      
          me.map.fitBounds(me.resultLyr.getBounds());     
        }
        catch (e){
          alert("There is no valid data in this query.<br>"+e);
        }
      }
      else{
        alert("There is no valid data in this query.");
      }
             
      $("#refreshDataID").html("Check Points");  
      $("#loadinggf").hide();
    }

    function closeseriesDiv(){
        $('#viewDiv').height('100%');//$('#splitd').height()
        $('#timeseriesDiv').hide();
        $('#closeseries').hide();
        $('#basemaps-wrapper').css('bottom',90);
    }

    function badgeCLick(b){

      $("#loadinggf").show();

      for (var group in me.datalist){ 
          
          if(me.datalist[group].ID == Number($(this).attr('data'))){
            map.setView([me.datalist[group].Latitude, me.datalist[group].Longitude], 17);
            me.featureName = me.datalist[group].Location;
          }
      }

      var dateFrom = new Date();
      dateFrom = dateFrom.setDate(dateFrom.getDate() - 10);
      var dateTo = new Date();
      var dateStringTo = dateTo.toISOString();
      var dateStringFrom = new Date(dateFrom).toISOString();

      var requesturl = "https://localhost:44321/api/Tenant/1190/Report/Custom/IndoorSensor/Data/Hourly?Id="+Number($(this).attr('data'))+"&endDt="+dateStringTo+"&startDt="+dateStringFrom;

      $("#loadinggf").show();
      $('#timeseriesDiv').show();

      $.ajax({
          type: "GET",
          url: requesturl
      })
      .fail(function (error) {
          alert("Service Error For Requested Locations");
      })
      .done(function (data) {
          $('#viewDiv').height($('#splitd').height() - 185);
          $('#basemaps-wrapper').css('bottom',270);

          var dataPointsTemp_Avg = [];
          var dataPointsHumidity_Avg = []
          var dataPointsSO2_Avg = [];
          var dataPointsCO_Avg = [];
          for (var i = 0; i < data.length; i++) {
            dataPointsTemp_Avg.push({
              x: new Date(data[i].LocalReadingDt),
              y: data[i].Temp_Avg
            });

            dataPointsHumidity_Avg.push({
              x: new Date(data[i].LocalReadingDt),
              y: data[i].Humidity_Avg
            });

            dataPointsCO_Avg.push({
              x: new Date(data[i].LocalReadingDt),
              y: data[i].CO_Avg
            });

            dataPointsSO2_Avg.push({
              x: new Date(data[i].LocalReadingDt),
              y: data[i].SO2_Avg
            });
          }

          var chart = new CanvasJS.Chart("timeseriesDiv", {
          /*title:{
            text: ""
          },*/
          animationEnabled: true,
          zoomEnabled: true,
          axisY:[{
            title: "Temp Avg",
            lineColor: "#C24642",
            tickColor: "#C24642",
            labelFontColor: "#C24642",
            titleFontColor: "#C24642",
            suffix: "°"
          },
          {
            title: "Humidity",
            lineColor: "#369EAD",
            tickColor: "#369EAD",
            labelFontColor: "#369EAD",
            titleFontColor: "#369EAD"
          }],
          axisY2: {
            title: "Value",
            lineColor: "#7F6084",
            tickColor: "#7F6084",
            labelFontColor: "#7F6084",
            titleFontColor: "#7F6084"
          },
          toolTip: {
            shared: true
          },
          legend: {
            cursor: "pointer",
            itemclick: toggleDataSeries
          },
          data: [{
            type: "line",
            name: "Humidity",
            color: "#369EAD",
            showInLegend: true,
            axisYIndex: 1,
            dataPoints: dataPointsHumidity_Avg
          },
          {
            type: "line",
            name: "Temp Avg",
            color: "#C24642",
            axisYIndex: 0,
            showInLegend: true,
            dataPoints: dataPointsTemp_Avg
          },
          {
            type: "line",
            name: "CO Avg",
            color: "#7F6084",
            axisYType: "secondary",
            showInLegend: true,
            dataPoints: dataPointsCO_Avg
          },
          {
            type: "line",
            name: "SO Avg",
            color: "blue",
            axisYType: "secondary",
            showInLegend: true,
            dataPoints: dataPointsSO2_Avg
          }]
        });
        chart.render();
        $("#loadinggf").hide();
        $('#closeseries').show();
      });
    }

    function toggleInterpolateLayer(e){
        if(me.resultLyr.options){
          if($('#interpLayerToggle').prop('checked') == true){
              me.map.addLayer(me.resultLyr);
              me.map.fitBounds(me.resultLyr.getBounds()); 
          }
          else{
              me.map.removeLayer(me.resultLyr);
          } 
        }
    }

    function setBasemap(basemap) {
      if (me.layer) {
        me.map.removeLayer(me.layer);
      }

      me.layer = L.esri.basemapLayer(basemap);

      me.map.addLayer(me.layer);
    }

    function changeBasemap(basemaps){
      var basemap = basemaps.value;
      setBasemap(basemap);
    }

    function toggleDataSeries(e) {
      if (typeof (e.dataSeries.visible) === "undefined" || e.dataSeries.visible) {
        e.dataSeries.visible = false;
      } else {
        e.dataSeries.visible = true;
      }
      e.chart.render();
    }

    function addOtherthings(){
      var logo = L.control({position: 'topright'});
      logo.onAdd = function(map){
          var div = L.DomUtil.create('div', 'myclass');
          div.innerHTML= "<a target='_blank' href='http://live.terrabase.com'><img width='60px' src='realtime/tb.png'/></a>";
          return div;
      }
      logo.addTo(map);
    }
</script>
</body>
</html>